<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes — Bilingual, Fast, and Interactive</title>
    <meta name="description" content="A beautiful, fast, and interactive bilingual notes app. Add, search, sort, edit, and manage English–Indonesian word pairs with offline support.">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Enable class-based dark mode for Tailwind CDN build
      tailwind.config = { darkMode: 'class' };
    </script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="manifest" href="manifest.json">
    <meta id="theme-color" name="theme-color" content="#ffffff" />
    <link rel="icon" href="images/letter-n.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
      :root { --ring: 62 100% 67%; }
      html { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
      /* Card flip */
      .flip { perspective: 1000px; }
      .flip-inner { transform-style: preserve-3d; transition: transform .6s; }
      .flip[data-flipped="true"] .flip-inner { transform: rotateY(180deg); }
      .flip-face { backface-visibility: hidden; }
      .flip-back { transform: rotateY(180deg); }
      /* Fancy gradient ring */
      .brand-ring { box-shadow: 0 0 0 4px hsl(var(--ring) / .2); }
      /* Overflow action strip (hover on desktop, tap-toggle on mobile) */
      .action-strip.show { opacity: 1 !important; pointer-events: auto !important; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 min-h-screen">
    <!-- Top Navigation -->
    <nav class="sticky top-0 z-40 backdrop-blur bg-white/70 dark:bg-gray-900/70 border-b border-gray-200/70 dark:border-gray-800">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="h-16 flex items-center justify-between">
          <a href="#" class="flex items-center gap-3 group">
            <img src="images/letter-n.png" alt="Notes logo" class="h-9 w-9 rounded-full brand-ring group-hover:scale-105 transition" />
            <div>
              <div class="text-xl font-bold tracking-tight">Notes</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">English ↔ Indonesian</div>
            </div>
          </a>
          <div class="flex items-center gap-3">
            <div class="relative hidden sm:block">
              <input id="search-input" type="search" placeholder="Search notes... (/)" class="w-64 rounded-xl border border-gray-300 dark:border-gray-700 bg-white/70 dark:bg-gray-800/70 px-4 py-2 pl-9 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <svg class="absolute left-2.5 top-2.5 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"/></svg>
            </div>
            <button id="theme-toggle" class="inline-flex items-center gap-2 rounded-xl border border-gray-300 dark:border-gray-700 px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-800" aria-label="Toggle dark mode">
              <svg id="theme-icon-sun" class="h-5 w-5 hidden dark:block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v2m0 14v2m9-9h-2M5 12H3m15.364 6.364l-1.414-1.414M7.05 7.05L5.636 5.636m12.728 0L17.95 7.05M7.05 16.95l-1.414 1.414"/></svg>
              <svg id="theme-icon-moon" class="h-5 w-5 dark:hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
              <span class="hidden sm:inline">Theme</span>
            </button>
            <button id="review-btn" class="inline-flex items-center gap-2 rounded-xl bg-emerald-600 text-white px-3 py-2 text-sm hover:bg-emerald-700" title="Start review (R)">
              <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
              <span class="hidden sm:inline">Review</span>
            </button>
            <span id="due-badge" class="ml-1 inline-flex items-center rounded-full bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-200 text-xs font-semibold px-2 py-1">0 due</span>
            <span id="count-badge" class="ml-1 inline-flex items-center rounded-full bg-blue-600 text-white text-xs font-semibold px-2 py-1">0</span>
          </div>
        </div>
      </div>
    </nav>

    <!-- Hero -->
    <header class="relative overflow-hidden">
      <div class="pointer-events-none absolute inset-0 bg-gradient-to-br from-blue-50 via-transparent to-purple-50 dark:from-blue-900/20 dark:to-purple-900/10"></div>
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 sm:py-14">
        <div class="grid md:grid-cols-2 gap-8 items-center">
          <div>
            <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">Capture bilingual notes with style</h1>
            <p class="mt-3 text-gray-600 dark:text-gray-400">Add English–Indonesian pairs, search instantly, flip to reveal, edit inline, and keep everything offline.</p>
            <ul class="mt-4 text-sm text-gray-600 dark:text-gray-400 space-y-1">
              <li>• Press / to search, N to add a new note, and D to toggle dark mode.</li>
            </ul>
          </div>
          <div class="md:justify-self-end">
            <div class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white/70 dark:bg-gray-800/70 p-4 shadow-sm">
              <div class="text-xs uppercase tracking-wider text-gray-500 mb-2">Quick Add</div>
              <form id="add-note-form" class="space-y-2">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                  <label class="sr-only" for="english_word">English</label>
                  <input id="english_word" name="english_word" type="text" placeholder="English word" class="rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                  <label class="sr-only" for="indonesian_word">Indonesian</label>
                  <input id="indonesian_word" name="indonesian_word" type="text" placeholder="Indonesian translation" class="rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                  <label class="sr-only" for="tags_input">Tags</label>
                  <input id="tags_input" name="tags_input" type="text" placeholder="Tags (optional, comma-separated)" class="w-full rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-center gap-2">
                  <button type="submit" class="inline-flex items-center justify-center gap-2 rounded-xl bg-blue-600 text-white px-4 py-2 font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add note
                  </button>
                  <button id="clear-all" type="button" class="ml-auto inline-flex items-center justify-center gap-2 rounded-xl border border-gray-300 dark:border-gray-700 px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-800">Clear all</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Toolbar -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
      <div class="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
        <div class="sm:hidden">
          <input id="search-input-mobile" type="search" placeholder="Search notes... (/)" class="w-full rounded-xl border border-gray-300 dark:border-gray-700 bg-white/70 dark:bg-gray-800/70 px-4 py-2 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <div class="flex flex-wrap items-center gap-2 text-sm">
            <label for="sort-select" class="text-gray-500 dark:text-gray-400">Sort</label>
            <select id="sort-select" class="rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 focus:outline-none">
              <option value="newest">Newest</option>
              <option value="oldest">Oldest</option>
              <option value="a-z">A → Z (English)</option>
              <option value="z-a">Z → A (English)</option>
            </select>
            
            <button id="favorites-filter" class="inline-flex items-center gap-1 rounded-xl border border-gray-300 dark:border-gray-700 px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-800" data-active="false">
              <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
              Favorites
            </button>
            
            <div class="relative">
              <select id="tag-filter" class="rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 focus:outline-none text-sm">
                <option value="">All Tags</option>
              </select>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <div class="relative">
              <button id="export-btn" class="inline-flex items-center gap-2 rounded-xl border border-gray-300 dark:border-gray-700 px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-800">
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3M3 17V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>
                Export
                <svg class="h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </button>
              <div id="export-menu" class="absolute right-0 mt-1 w-32 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-lg z-10 hidden">
                <button id="export-json" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-t-xl">JSON</button>
                <button id="export-csv" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-b-xl">CSV</button>
              </div>
            </div>
            <div class="relative">
              <button id="import-btn" class="inline-flex items-center gap-2 rounded-xl border border-gray-300 dark:border-gray-700 px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-800">
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/></svg>
                Import
                <svg class="h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
              </button>
              <div id="import-menu" class="absolute right-0 mt-1 w-32 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-lg z-10 hidden">
                <button id="import-json" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-t-xl">JSON</button>
                <button id="import-csv" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-b-xl">CSV</button>
              </div>
            </div>
          </div>
        </div
      </div>
    </section>

    <!-- Notes Grid -->
    <!-- Hidden file input for imports -->
    <input type="file" id="file-input" accept=".json,.csv" style="display: none;">

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6 mb-24">
      <div id="empty-state" class="rounded-2xl border border-dashed border-gray-300 dark:border-gray-700 p-8 text-center text-gray-500 dark:text-gray-400">
        No notes yet. Add your first English–Indonesian pair above.
      </div>
      <div id="notes-container" class="mt-4 grid gap-4 grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4"></div>
    </main>

    <!-- Review Modal -->
    <div id="review-modal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/40"></div>
      <div class="relative mx-auto mt-20 max-w-xl px-4">
        <div class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-xl">
          <div class="flex items-center justify-between px-4 pt-4">
            <div id="review-progress" class="text-sm text-gray-500 dark:text-gray-400">0 / 0</div>
            <button id="review-close" class="rounded-lg border border-gray-300 dark:border-gray-700 px-3 py-1 text-sm hover:bg-gray-100 dark:hover:bg-gray-800">Close</button>
          </div>
          <div class="px-4 pb-4">
            <div id="review-card" class="mt-2 rounded-xl border border-gray-200 dark:border-gray-800 p-6 bg-white dark:bg-gray-800 flip" data-flipped="false">
              <div class="flip-inner">
                <div class="flip-face">
                  <div id="review-front-en" class="text-2xl font-bold tracking-tight"></div>
                </div>
                <div class="flip-face flip-back">
                  <div id="review-back-id" class="text-2xl font-bold tracking-tight"></div>
                </div>
              </div>
            </div>
            <div class="mt-4 flex flex-col items-center gap-2">
              <button id="review-show" class="inline-flex items-center gap-2 rounded-xl border border-gray-300 dark:border-gray-700 px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-800">Show answer (Space)</button>
              <div class="flex items-center gap-2">
                <button id="review-speak-en" class="tts-only inline-flex items-center gap-1 rounded-xl border border-gray-300 dark:border-gray-700 px-3 py-1 text-sm hover:bg-gray-100 dark:hover:bg-gray-800" title="Speak English">
                  <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5l-7 7 7 7M19 5v14"/></svg>
                  EN
                </button>
                <button id="review-speak-id" class="tts-only inline-flex items-center gap-1 rounded-xl border border-gray-300 dark:border-gray-700 px-3 py-1 text-sm hover:bg-gray-100 dark:hover:bg-gray-800" title="Ucapkan Indonesia">
                  <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5l-7 7 7 7M19 5v14"/></svg>
                  ID
                </button>
                <button id="review-stop-tts" class="tts-only inline-flex items-center gap-1 rounded-xl border border-gray-300 dark:border-gray-700 px-3 py-1 text-sm hover:bg-gray-100 dark:hover:bg-gray-800" title="Stop suara">Stop</button>
              </div>
            </div>
            <div id="review-grades" class="mt-3 grid grid-cols-4 gap-2 hidden">
              <button id="grade-again" class="rounded-xl bg-red-600 text-white px-3 py-2 text-sm hover:bg-red-700">Again</button>
              <button id="grade-hard" class="rounded-xl border border-gray-300 dark:border-gray-700 px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-800">Hard</button>
              <button id="grade-good" class="rounded-xl bg-blue-600 text-white px-3 py-2 text-sm hover:bg-blue-700">Good</button>
              <button id="grade-easy" class="rounded-xl border border-gray-300 dark:border-gray-700 px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-800">Easy</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-800 mt-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid md:grid-cols-3 gap-8">
          <div>
            <div class="flex items-center gap-3 mb-3">
              <img src="images/letter-n.png" alt="Notes logo" class="h-8 w-8 rounded-full" />
              <div class="text-lg font-bold">Notes</div>
            </div>
            <p class="text-gray-600 dark:text-gray-400 text-sm leading-relaxed">
              A beautiful, fast, and interactive bilingual notes app for English–Indonesian word pairs with spaced repetition.
            </p>
          </div>
          
          <div>
            <h3 class="font-semibold mb-3">Features</h3>
            <ul class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
              <li class="flex items-center gap-2">
                <svg class="h-4 w-4 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Offline support
              </li>
              <li class="flex items-center gap-2">
                <svg class="h-4 w-4 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Spaced repetition
              </li>
              <li class="flex items-center gap-2">
                <svg class="h-4 w-4 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Text-to-speech
              </li>
              <li class="flex items-center gap-2">
                <svg class="h-4 w-4 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Import & Export
              </li>
            </ul>
          </div>
          
          <div>
            <h3 class="font-semibold mb-3">Keyboard Shortcuts</h3>
            <ul class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
              <li><kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded text-xs font-mono">/</kbd> Search notes</li>
              <li><kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded text-xs font-mono">N</kbd> Add new note</li>
              <li><kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded text-xs font-mono">D</kbd> Toggle dark mode</li>
              <li><kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded text-xs font-mono">R</kbd> Start review</li>
            </ul>
          </div>
        </div>
        
        <div class="border-t border-gray-200 dark:border-gray-800 mt-8 pt-6 text-center">
          <p class="text-sm text-gray-500 dark:text-gray-400">
            Built with ❤️ for language learners • 
            <span class="inline-flex items-center gap-1">
              <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"/></svg>
              Stored locally in your browser
            </span>
          </p>
        </div>
      </div>
    </footer>

    <script>
      // Service worker registration (preserved)
      if ('serviceWorker' in navigator && location.protocol.startsWith('http')) {
        navigator.serviceWorker.register('/sw.js').then((reg) => {
          console.log('Service worker registered.', reg);
        });
      }


      // Elements
      const addNoteForm = document.getElementById('add-note-form');
      const englishWordInput = document.getElementById('english_word');
      const indonesianWordInput = document.getElementById('indonesian_word');
      const tagsInput = document.getElementById('tags_input');
      const notesContainer = document.getElementById('notes-container');
      const emptyState = document.getElementById('empty-state');
      const searchDesktop = document.getElementById('search-input');
      const searchMobile = document.getElementById('search-input-mobile');
      const sortSelect = document.getElementById('sort-select');
      const favoritesFilter = document.getElementById('favorites-filter');
      const tagFilter = document.getElementById('tag-filter');
      const countBadge = document.getElementById('count-badge');
      const themeToggle = document.getElementById('theme-toggle');
      const themeMeta = document.getElementById('theme-color');
      const clearAllBtn = document.getElementById('clear-all');
      const exportBtn = document.getElementById('export-btn');
      const importBtn = document.getElementById('import-btn');
      const exportMenu = document.getElementById('export-menu');
      const importMenu = document.getElementById('import-menu');
      const exportJsonBtn = document.getElementById('export-json');
      const exportCsvBtn = document.getElementById('export-csv');
      const importJsonBtn = document.getElementById('import-json');
      const importCsvBtn = document.getElementById('import-csv');
      const fileInput = document.getElementById('file-input');

      // Review elements
      const reviewBtn = document.getElementById('review-btn');
      const dueBadge = document.getElementById('due-badge');
      const reviewModal = document.getElementById('review-modal');
      const reviewProgress = document.getElementById('review-progress');
      const reviewCard = document.getElementById('review-card');
      const reviewFrontEn = document.getElementById('review-front-en');
      const reviewBackId = document.getElementById('review-back-id');
      const reviewShow = document.getElementById('review-show');
      const reviewGrades = document.getElementById('review-grades');
      const reviewClose = document.getElementById('review-close');
      const gradeAgain = document.getElementById('grade-again');
      const gradeHard = document.getElementById('grade-hard');
      const gradeGood = document.getElementById('grade-good');
      const gradeEasy = document.getElementById('grade-easy');
      // Review TTS buttons
      const reviewSpeakEn = document.getElementById('review-speak-en');
      const reviewSpeakId = document.getElementById('review-speak-id');
      const reviewStopTts = document.getElementById('review-stop-tts');

      // State
      let notes = [];
      let filterText = '';
      let showFavoritesOnly = false;
      let selectedTag = '';
      let reviewQueue = [];
      let reviewIndex = 0;

      // Storage helpers
      const NOTES_KEY = 'notes-data-v1';
      const THEME_KEY = 'theme-preference';
      // TTS preference keys
      const TTS_VOICE_EN_KEY = 'tts-voice-en';
      const TTS_VOICE_ID_KEY = 'tts-voice-id';
      const TTS_RATE_KEY = 'tts-rate';
      const TTS_PITCH_KEY = 'tts-pitch';
      const TTS_VOLUME_KEY = 'tts-volume';
      function saveNotes() { localStorage.setItem(NOTES_KEY, JSON.stringify(notes)); }
      function loadNotes() {
        try { notes = JSON.parse(localStorage.getItem(NOTES_KEY) || '[]'); }
        catch { notes = []; }
      }
      function getNumberPref(key, defVal) {
        const v = parseFloat(localStorage.getItem(key));
        return Number.isFinite(v) ? v : defVal;
      }

      // TTS helpers (Web Speech API)
      const ttsSupported = 'speechSynthesis' in window && 'SpeechSynthesisUtterance' in window;
      let ttsVoices = [];
      function populateVoiceSelects() {
        if (!voiceEnSelect || !voiceIdSelect) return;
        // Clear
        voiceEnSelect.innerHTML = '';
        voiceIdSelect.innerHTML = '';
        const savedEn = localStorage.getItem(TTS_VOICE_EN_KEY) || '';
        const savedId = localStorage.getItem(TTS_VOICE_ID_KEY) || '';
        const makeOption = (v) => {
          const opt = document.createElement('option');
          opt.value = v.voiceURI || v.name || '';
          opt.textContent = `${v.name || 'Unknown'} (${v.lang || 'n/a'})${v.localService ? '' : ' • remote'}`;
          return opt;
        };
        const enVoices = ttsVoices.filter(v => (v.lang || '').toLowerCase().startsWith('en'));
        const idVoices = ttsVoices.filter(v => (v.lang || '').toLowerCase().startsWith('id') || (v.lang || '').toLowerCase().includes('id'));
        enVoices.forEach(v => voiceEnSelect.appendChild(makeOption(v)));
        idVoices.forEach(v => voiceIdSelect.appendChild(makeOption(v)));
        // Preselect saved
        if (savedEn) {
          const found = enVoices.find(v => v.voiceURI === savedEn || v.name === savedEn);
          if (found) voiceEnSelect.value = found.voiceURI || found.name;
        }
        if (!voiceEnSelect.value && enVoices[0]) voiceEnSelect.value = enVoices[0].voiceURI || enVoices[0].name;
        if (savedId) {
          const found = idVoices.find(v => v.voiceURI === savedId || v.name === savedId);
          if (found) voiceIdSelect.value = found.voiceURI || found.name;
        }
        if (!voiceIdSelect.value && idVoices[0]) voiceIdSelect.value = idVoices[0].voiceURI || idVoices[0].name;
        // Initialize sliders with saved values
        if (ttsRateInput) ttsRateInput.value = String(getNumberPref(TTS_RATE_KEY, 1));
        if (ttsPitchInput) ttsPitchInput.value = String(getNumberPref(TTS_PITCH_KEY, 1));
        if (ttsVolumeInput) ttsVolumeInput.value = String(getNumberPref(TTS_VOLUME_KEY, 1));
      }
      function refreshVoices() {
        try { ttsVoices = window.speechSynthesis?.getVoices() || []; } catch { ttsVoices = []; }
        try { populateVoiceSelects(); } catch {}
      }
      if ('speechSynthesis' in window) {
        refreshVoices();
        window.speechSynthesis.onvoiceschanged = refreshVoices;
      }
      function pickVoice(langHint) {
        const hint = (langHint || '').toLowerCase();
        // Honor saved preference first
        try {
          const key = hint.startsWith('id') ? TTS_VOICE_ID_KEY : TTS_VOICE_EN_KEY;
          const saved = localStorage.getItem(key);
          if (saved) {
            const preferred = ttsVoices.find(v => v.voiceURI === saved) || ttsVoices.find(v => v.name === saved);
            if (preferred) return preferred;
          }
        } catch {}
        // Then language-based selection
        const primary = ttsVoices.find(v => (v.lang || '').toLowerCase().startsWith(hint));
        if (primary) return primary;
        if (hint.startsWith('id')) {
          // fallback to any Indonesian-like voice
          const idLike = ttsVoices.find(v => (v.lang || '').toLowerCase().includes('id'));
          if (idLike) return idLike;
        }
        // fallback to English, else first voice
        return ttsVoices.find(v => (v.lang || '').toLowerCase().startsWith('en')) || ttsVoices[0] || null;
      }
      function clamp(n, min, max) { return Math.min(max, Math.max(min, n)); }
      async function speak(text, langHint) {
        if (!ttsSupported) { 
          await Swal.fire({
            title: 'TTS Not Supported',
            text: 'Text-to-Speech is not supported in this browser.',
            icon: 'error',
            confirmButtonColor: '#3085d6'
          }); 
          return; 
        }
        if (!text) return;
        const u = new SpeechSynthesisUtterance(String(text));
        const voice = pickVoice(langHint);
        if (voice) { u.voice = voice; u.lang = voice.lang; }
        else { u.lang = langHint === 'id' ? 'id-ID' : 'en-US'; }
        const rate = clamp(getNumberPref(TTS_RATE_KEY, 1), 0.1, 3);
        const pitch = clamp(getNumberPref(TTS_PITCH_KEY, 1), 0, 2);
        const volume = clamp(getNumberPref(TTS_VOLUME_KEY, 1), 0, 1);
        u.rate = rate; u.pitch = pitch; u.volume = volume;
        try { window.speechSynthesis.cancel(); } catch {}
        window.speechSynthesis.speak(u);
      }

      function stopSpeak() { try { window.speechSynthesis?.cancel(); } catch {} }

      // Scheduling (SM-2) helpers
      function ensureSchedule(n) {
        if (n.ease == null) n.ease = 2.5;
        if (n.repetitions == null) n.repetitions = 0;
        if (n.interval == null) n.interval = 0; // in days
        if (n.lapses == null) n.lapses = 0;
        if (n.lastReviewedAt == null) n.lastReviewedAt = 0;
        if (n.dueAt == null) n.dueAt = Date.now();
      }
      function ensureScheduleForAll() { notes.forEach(ensureSchedule); }
      function getDueNotes() {
        const now = Date.now();
        return notes.filter(n => (n.dueAt || 0) <= now);
      }
      function updateDueBadge() {
        if (!dueBadge) return;
        const due = getDueNotes().length;
        dueBadge.textContent = `${due} due`;
        // Color hinting already styled; nothing else needed
      }
      function sm2Review(n, q) {
        ensureSchedule(n);
        // Update ease factor
        let ease = n.ease;
        ease = ease + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02));
        if (ease < 1.3) ease = 1.3;

        if (q < 3) {
          n.repetitions = 0;
          n.lapses = (n.lapses || 0) + 1;
          n.interval = 1; // schedule for tomorrow
        } else {
          n.repetitions = (n.repetitions || 0) + 1;
          if (n.repetitions === 1) n.interval = 1;
          else if (n.repetitions === 2) n.interval = 6;
          else n.interval = Math.round((n.interval || 1) * ease);
        }

        n.ease = ease;
        n.lastReviewedAt = Date.now();
        n.dueAt = n.lastReviewedAt + n.interval * 86400000; // ms in a day
      }

      async function startReview() {
        reviewQueue = getDueNotes().sort((a, b) => (a.dueAt || 0) - (b.dueAt || 0));
        if (reviewQueue.length === 0) {
          await Swal.fire({
            title: 'No Cards Due',
            text: 'No cards are due for review right now.',
            icon: 'info',
            confirmButtonColor: '#3085d6'
          });
          return;
        }
        reviewIndex = 0;
        showCurrentReviewCard();
        reviewModal.classList.remove('hidden');
      }
      function closeReview() {
        reviewModal.classList.add('hidden');
        reviewQueue = [];
        reviewIndex = 0;
      }
      function showCurrentReviewCard() {
        const n = reviewQueue[reviewIndex];
        if (!n) return;
        reviewCard.setAttribute('data-flipped', 'false');
        reviewFrontEn.textContent = n.en;
        reviewBackId.textContent = n.id;
        reviewProgress.textContent = `${reviewIndex + 1} / ${reviewQueue.length}`;
        reviewShow.classList.remove('hidden');
        reviewGrades.classList.add('hidden');
      }
      function revealAnswer() {
        reviewCard.setAttribute('data-flipped', 'true');
        reviewShow.classList.add('hidden');
        reviewGrades.classList.remove('hidden');
      }
      function gradeAndNext(q) {
        const n = reviewQueue[reviewIndex];
        if (!n) return;
        sm2Review(n, q);
        saveNotes();
        updateDueBadge();
        reviewIndex++;
        if (reviewIndex >= reviewQueue.length) {
          reviewModal.classList.add('hidden');
          Swal.fire({
            title: 'Review Complete!',
            text: 'Great job! You\'ve completed all due cards.',
            icon: 'success',
            confirmButtonColor: '#3085d6'
          });
          renderNotes();
          return;
        }
        showCurrentReviewCard();
      }

      // Theme helpers
      function applyTheme(theme) {
        const root = document.documentElement;
        if (theme === 'dark') {
          root.classList.add('dark');
          themeMeta.setAttribute('content', '#111827'); // gray-900
        } else {
          root.classList.remove('dark');
          themeMeta.setAttribute('content', '#ffffff');
        }
      }
      function initTheme() {
        const stored = localStorage.getItem(THEME_KEY);
        const preferDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = stored || (preferDark ? 'dark' : 'light');
        applyTheme(theme);
      }

      // Rendering
      function updateCount() { countBadge.textContent = String(notes.length); }
      function setEmptyStateVisible(isVisible) { emptyState.style.display = isVisible ? '' : 'none'; }

      function updateTagFilter() {
        const allTags = [...new Set(notes.flatMap(note => note.tags || []))].sort();
        const currentValue = tagFilter.value;
        tagFilter.innerHTML = '<option value="">All Tags</option>';
        allTags.forEach(tag => {
          const option = document.createElement('option');
          option.value = tag;
          option.textContent = tag.charAt(0).toUpperCase() + tag.slice(1);
          tagFilter.appendChild(option);
        });
        if (allTags.includes(currentValue)) {
          tagFilter.value = currentValue;
        }
      }

      function renderNotes() {
        // Filter and sort
        const q = filterText.trim().toLowerCase();
        let view = notes.filter(n => {
          // Text search
          const matchesText = n.en.toLowerCase().includes(q) || 
                             n.id.toLowerCase().includes(q) ||
                             (n.tags && n.tags.some(tag => tag.toLowerCase().includes(q)));
          
          // Favorites filter
          const matchesFavorites = !showFavoritesOnly || n.isFavorite;
          
          // Tag filter
          const matchesTag = !selectedTag || (n.tags && n.tags.includes(selectedTag));
          
          return matchesText && matchesFavorites && matchesTag;
        });
        
        const sort = sortSelect.value;
        view.sort((a,b) => {
          if (sort === 'newest') return b.createdAt - a.createdAt;
          if (sort === 'oldest') return a.createdAt - b.createdAt;
          if (sort === 'a-z') return a.en.localeCompare(b.en);
          if (sort === 'z-a') return b.en.localeCompare(a.en);
          return 0;
        });

        notesContainer.innerHTML = '';
        view.forEach(n => notesContainer.appendChild(createNoteElement(n)));
        setEmptyStateVisible(view.length === 0);
        updateCount();
      }

      // Color system for cards
      function getCardColor(note) {
        // Generate consistent color based on note ID for persistence
        const colors = [
          { light: 'bg-rose-100 border-rose-300', dark: 'dark:bg-rose-900/30 dark:border-rose-600' },
          { light: 'bg-sky-100 border-sky-300', dark: 'dark:bg-sky-900/30 dark:border-sky-600' },
          { light: 'bg-emerald-100 border-emerald-300', dark: 'dark:bg-emerald-900/30 dark:border-emerald-600' },
          { light: 'bg-amber-100 border-amber-300', dark: 'dark:bg-amber-900/30 dark:border-amber-600' },
          { light: 'bg-violet-100 border-violet-300', dark: 'dark:bg-violet-900/30 dark:border-violet-600' },
          { light: 'bg-pink-100 border-pink-300', dark: 'dark:bg-pink-900/30 dark:border-pink-600' },
          { light: 'bg-indigo-100 border-indigo-300', dark: 'dark:bg-indigo-900/30 dark:border-indigo-600' },
          { light: 'bg-teal-100 border-teal-300', dark: 'dark:bg-teal-900/30 dark:border-teal-600' },
          { light: 'bg-orange-100 border-orange-300', dark: 'dark:bg-orange-900/30 dark:border-orange-600' },
          { light: 'bg-cyan-100 border-cyan-300', dark: 'dark:bg-cyan-900/30 dark:border-cyan-600' },
          { light: 'bg-lime-100 border-lime-300', dark: 'dark:bg-lime-900/30 dark:border-lime-600' },
          { light: 'bg-fuchsia-100 border-fuchsia-300', dark: 'dark:bg-fuchsia-900/30 dark:border-fuchsia-600' },
          { light: 'bg-red-100 border-red-300', dark: 'dark:bg-red-900/30 dark:border-red-600' },
          { light: 'bg-blue-100 border-blue-300', dark: 'dark:bg-blue-900/30 dark:border-blue-600' },
          { light: 'bg-green-100 border-green-300', dark: 'dark:bg-green-900/30 dark:border-green-600' },
          { light: 'bg-purple-100 border-purple-300', dark: 'dark:bg-purple-900/30 dark:border-purple-600' }
        ];
        
        // Use note ID to create a consistent hash for color selection
        let hash = 0;
        for (let i = 0; i < note.id.length; i++) {
          const char = note.id.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash; // Convert to 32-bit integer
        }
        
        const colorIndex = Math.abs(hash) % colors.length;
        const selectedColor = colors[colorIndex];
        return `${selectedColor.light} ${selectedColor.dark}`;
      }

      // Card element factory
      function createNoteElement(note) {
        const card = document.createElement('div');
        const colorClasses = getCardColor(note);
        card.className = `relative rounded-2xl ${colorClasses} shadow-sm hover:shadow-md transition overflow-hidden flip`;
        card.setAttribute('data-id', note.id);
        card.setAttribute('tabindex', '0');

        const inner = document.createElement('div');
        inner.className = 'flip-inner p-4 min-h-[120px]';

        const front = document.createElement('div');
        front.className = 'flip-face flex h-full flex-col justify-between';
        const frontTags = note.tags && note.tags.length > 0 ? 
          `<div class="flex flex-wrap gap-1 mt-1">${note.tags.map(tag => `<span class="inline-block bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 text-xs px-2 py-1 rounded-full">${escapeHtml(tag)}</span>`).join('')}</div>` : '';
        front.innerHTML = `
          <div>
            <div class="flex items-center justify-between gap-2">
              <button class="btn-speak-en text-left text-lg font-semibold tracking-tight focus:outline-none" title="Play pronunciation (EN)">${escapeHtml(note.en)}</button>
            </div>
            ${frontTags}
          </div>
          <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">Tap to flip</div>
        `;

        const back = document.createElement('div');
        back.className = 'flip-face flip-back flex h-full flex-col justify-between';
        const backTags = note.tags && note.tags.length > 0 ? 
          `<div class="flex flex-wrap gap-1 mt-1">${note.tags.map(tag => `<span class="inline-block bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 text-xs px-2 py-1 rounded-full">${escapeHtml(tag)}</span>`).join('')}</div>` : '';
        back.innerHTML = `
          <div>
            <div class="flex items-center justify-between gap-2">
              <button class="btn-speak-id text-left text-lg font-semibold tracking-tight focus:outline-none" title="Putar pelafalan (ID)">${escapeHtml(note.id)}</button>
            </div>
            ${backTags}
          </div>
          <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">Tap to flip back</div>
        `;

        inner.appendChild(front);
        inner.appendChild(back);
        card.appendChild(inner);

        // Stationary overflow menu at top-right (stays during flip)
        const menuRoot = document.createElement('div');
        menuRoot.className = 'menu-root absolute top-2 right-2 z-10 group/menu';
        menuRoot.innerHTML = `
          <div class="action-strip absolute right-full mr-2 top-1/2 -translate-y-1/2 flex gap-1 bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm border border-gray-200 dark:border-gray-700 rounded-xl p-1 shadow-lg overflow-x-auto max-w-[220px] opacity-0 pointer-events-none group-hover/menu:opacity-100 group-hover/menu:pointer-events-auto transition">
            <button class="btn-star p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800" title="${note.isFavorite ? 'Unfavorite' : 'Favorite'}">
              <svg class="h-4 w-4 ${note.isFavorite ? 'fill-yellow-400 text-yellow-400' : 'text-gray-500'}" xmlns="http://www.w3.org/2000/svg" fill="${note.isFavorite ? 'currentColor' : 'none'}" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
            </button>
            <button class="btn-copy p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800" title="Copy">
              <svg class="h-4 w-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2M8 16h8a2 2 0 002-2v-6M8 16v2a2 2 0 002 2h6"/></svg>
            </button>
            <button class="btn-edit p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800" title="Edit">
              <svg class="h-4 w-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4h2m2 0h2m-6 0H9m0 0H7m4 0v2m0 2v2m0-6v-2m0 10l-2 2m0 0l-2 2m4-4l2-2m0 0l2-2"/></svg>
            </button>
            <button class="btn-delete p-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30" title="Delete">
              <svg class="h-4 w-4 text-red-600 dark:text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
          <button class="btn-menu p-1 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800" title="More actions" aria-haspopup="true" aria-expanded="false">
            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6a2 2 0 110-4 2 2 0 010 4zm0 8a2 2 0 110-4 2 2 0 010 4zm0 8a2 2 0 110-4 2 2 0 010 4z"/></svg>
          </button>
        `;
        card.appendChild(menuRoot);

        // Actions bar
        // Flip on click or Enter/Space
        card.addEventListener('click', (e) => {
          const isButton = e.target.closest('button');
          if (isButton) return;
          toggleFlip(card);
        });
        card.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleFlip(card); }
        });

        return card;
      }

      function toggleFlip(card) {
        const flipped = card.getAttribute('data-flipped') === 'true';
        card.setAttribute('data-flipped', flipped ? 'false' : 'true');
      }

      // Escape helper to prevent injection in templates
      function escapeHtml(str) {
        return String(str).replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
      }

      // Deduplication helpers
      function isDuplicate(en, id) {
        return notes.some(note => 
          note.en.toLowerCase().trim() === en.toLowerCase().trim() && 
          note.id.toLowerCase().trim() === id.toLowerCase().trim()
        );
      }
      
      function findSimilarNotes(en, id) {
        return notes.filter(note => 
          note.en.toLowerCase().trim() === en.toLowerCase().trim() || 
          note.id.toLowerCase().trim() === id.toLowerCase().trim()
        );
      }
      
      async function showDuplicateWarning(en, id, similarNotes) {
        const result = await Swal.fire({
          title: 'Duplicate Entry Detected!',
          html: `
            <div class="text-left">
              <p class="mb-3">A similar entry already exists:</p>
              <div class="bg-gray-100 p-3 rounded-lg">
                <strong>English:</strong> ${escapeHtml(similarNotes[0].en)}<br>
                <strong>Indonesian:</strong> ${escapeHtml(similarNotes[0].id)}
              </div>
              <p class="mt-3 text-sm text-gray-600">Would you like to add it anyway?</p>
            </div>
          `,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Add Anyway',
          cancelButtonText: 'Cancel'
        });
        return result.isConfirmed;
      }

      // CRUD helpers
      async function addNote(en, id, tags = []) {
        const trimmedEn = en.trim();
        const trimmedId = id.trim();
        
        // Check for exact duplicates
        if (isDuplicate(trimmedEn, trimmedId)) {
          await Swal.fire({
            title: 'Duplicate Entry!',
            text: 'This exact word pair already exists.',
            icon: 'error',
            confirmButtonColor: '#3085d6'
          });
          return false;
        }
        
        // Check for similar entries
        const similarNotes = findSimilarNotes(trimmedEn, trimmedId);
        if (similarNotes.length > 0) {
          const shouldAdd = await showDuplicateWarning(trimmedEn, trimmedId, similarNotes);
          if (!shouldAdd) return false;
        }
        
        const note = { 
          id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2), 
          en: trimmedEn, 
          id: trimmedId, 
          tags: tags.filter(tag => tag.trim()).map(tag => tag.trim().toLowerCase()),
          isFavorite: false,
          createdAt: Date.now(),
          // Scheduling defaults
          ease: 2.5,
          repetitions: 0,
          interval: 0,
          lapses: 0,
          lastReviewedAt: 0,
          dueAt: Date.now()
        };
        notes.unshift(note);
        saveNotes();
        renderNotes();
        updateTagFilter();
        updateDueBadge();
        
        await Swal.fire({
          title: 'Success!',
          text: 'Note added successfully!',
          icon: 'success',
          timer: 1500,
          showConfirmButton: false
        });
        
        return true;
      }
      function deleteNote(noteId) {
        notes = notes.filter(n => n.id !== noteId);
        saveNotes();
        renderNotes();
        updateTagFilter();
        updateDueBadge();
      }
      function updateNote(noteId, en, id, tags = []) {
        const idx = notes.findIndex(n => n.id === noteId);
        if (idx !== -1) {
          notes[idx].en = en.trim();
          notes[idx].id = id.trim();
          notes[idx].tags = tags.filter(tag => tag.trim()).map(tag => tag.trim().toLowerCase());
          saveNotes();
          renderNotes();
          updateTagFilter();
          updateDueBadge();
        }
      }
      
      function toggleFavorite(noteId) {
        const idx = notes.findIndex(n => n.id === noteId);
        if (idx !== -1) {
          notes[idx].isFavorite = !notes[idx].isFavorite;
          saveNotes();
          renderNotes();
          updateDueBadge();
        }
      }

      // Inline edit UI
      function startInlineEdit(card) {
        const id = card.getAttribute('data-id');
        const n = notes.find(x => x.id === id);
        if (!n) return;
        card.innerHTML = '';
        const wrap = document.createElement('div');
        wrap.className = 'p-4 space-y-2';
        wrap.innerHTML = `
          <input id="edit-en" class="w-full rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" value="${escapeHtml(n.en)}" />
          <input id="edit-id" class="w-full rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" value="${escapeHtml(n.id)}" />
          <input id="edit-tags" class="w-full rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tags (comma-separated)" value="${escapeHtml((n.tags || []).join(', '))}" />
          <div class="flex gap-2 justify-end pt-1">
            <button class="btn-cancel rounded-xl border border-gray-300 dark:border-gray-700 px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-800">Cancel</button>
            <button class="btn-save rounded-xl bg-blue-600 text-white px-3 py-2 text-sm hover:bg-blue-700">Save</button>
          </div>
        `;
        card.classList.remove('flip');
        card.appendChild(wrap);
        wrap.querySelector('#edit-en').focus();
      }

      // Event wiring
      addNoteForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const en = englishWordInput.value.trim();
        const id = indonesianWordInput.value.trim();
        const tags = tagsInput.value.trim() ? tagsInput.value.split(',').map(t => t.trim()).filter(t => t) : [];
        
        if (!en || !id) {
          await Swal.fire({
            title: 'Missing Information!',
            text: 'Please enter both English and Indonesian words.',
            icon: 'warning',
            confirmButtonColor: '#3085d6'
          });
          return;
        }
        
        const success = await addNote(en, id, tags);
        if (success) {
          englishWordInput.value = '';
          indonesianWordInput.value = '';
          tagsInput.value = '';
          englishWordInput.focus();
        }
      });

      clearAllBtn.addEventListener('click', async () => {
        if (notes.length === 0) return;
        
        const result = await Swal.fire({
          title: 'Clear All Notes?',
          text: 'This action cannot be undone!',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'Yes, clear all!',
          cancelButtonText: 'Cancel'
        });
        
        if (result.isConfirmed) {
          notes = [];
          saveNotes();
          renderNotes();
          updateTagFilter();
          updateDueBadge();
          
          await Swal.fire({
            title: 'Cleared!',
            text: 'All notes have been deleted.',
            icon: 'success',
            timer: 1500,
            showConfirmButton: false
          });
        }
      });

      function onSearchInput(e) {
        filterText = e.target.value || '';
        renderNotes();
      }
      searchDesktop?.addEventListener('input', onSearchInput);
      searchMobile?.addEventListener('input', onSearchInput);

      sortSelect.addEventListener('change', renderNotes);
      
      // Favorites filter handler
      favoritesFilter.addEventListener('click', () => {
        showFavoritesOnly = !showFavoritesOnly;
        favoritesFilter.setAttribute('data-active', showFavoritesOnly.toString());
        favoritesFilter.style.backgroundColor = showFavoritesOnly ? 'rgb(59 130 246)' : '';
        favoritesFilter.style.color = showFavoritesOnly ? 'white' : '';
        renderNotes();
      });
      
      // Tag filter handler
      tagFilter.addEventListener('change', () => {
        selectedTag = tagFilter.value;
        renderNotes();
      });

      // Delegated actions on cards
      notesContainer.addEventListener('click', (e) => {
        const btnMenu = e.target.closest('.btn-menu');
        const btnStar = e.target.closest('.btn-star');
        const btnCopy = e.target.closest('.btn-copy');
        const btnEdit = e.target.closest('.btn-edit');
        const btnDelete = e.target.closest('.btn-delete');
        const btnSave = e.target.closest('.btn-save');
        const btnCancel = e.target.closest('.btn-cancel');
        const btnSpeakEn = e.target.closest('.btn-speak-en');
        const btnSpeakId = e.target.closest('.btn-speak-id');
        const card = e.target.closest('[data-id]');
        if (!card) return;
        const id = card.getAttribute('data-id');
        const n = notes.find(x => x.id === id);

        // toggle menu (mobile / click)
        if (btnMenu) {
          e.stopPropagation();
          // close others first
          document.querySelectorAll('.action-strip').forEach(el => el.classList.remove('show'));
          const strip = btnMenu.parentElement.querySelector('.action-strip');
          if (strip) strip.classList.toggle('show');
          return;
        }

        // actions
        if (btnStar) {
          toggleFavorite(id);
        } else if (btnCopy && n) {
          const tagsText = n.tags && n.tags.length > 0 ? ` [${n.tags.join(', ')}]` : '';
          navigator.clipboard?.writeText(`${n.en} — ${n.id}${tagsText}`);
        } else if (btnSpeakEn && n) {
          speak(n.en, 'en');
        } else if (btnSpeakId && n) {
          speak(n.id, 'id');
        } else if (btnEdit) {
          startInlineEdit(card);
        } else if (btnDelete) {
          Swal.fire({
            title: 'Delete Note?',
            text: 'This action cannot be undone!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!'
          }).then((result) => {
            if (result.isConfirmed) {
              deleteNote(id);
              Swal.fire({
                title: 'Deleted!',
                text: 'The note has been deleted.',
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
              });
            }
          });
        } else if (btnSave) {
          const en = card.querySelector('#edit-en').value;
          const idn = card.querySelector('#edit-id').value;
          const tagsText = card.querySelector('#edit-tags').value;
          const tags = tagsText.trim() ? tagsText.split(',').map(t => t.trim()).filter(t => t) : [];
          updateNote(id, en, idn, tags);
        } else if (btnCancel) {
          renderNotes();
        }

        // close any open action strips after an action
        document.querySelectorAll('.action-strip').forEach(el => el.classList.remove('show'));
      });

      // Keyboard shortcuts
      window.addEventListener('keydown', (e) => {
        const inInput = e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement;
        if (e.key === '/' && !inInput) {
          e.preventDefault();
          (searchDesktop || searchMobile).focus();
        }
        if (e.key.toLowerCase() === 'n' && !inInput) {
          e.preventDefault();
          englishWordInput.focus();
        }
        if (e.key.toLowerCase() === 'd' && !inInput) {
          e.preventDefault();
          const dark = document.documentElement.classList.contains('dark');
          const next = dark ? 'light' : 'dark';
          localStorage.setItem(THEME_KEY, next);
          applyTheme(next);
        }
        if (e.key.toLowerCase() === 'r' && !inInput) {
          e.preventDefault();
          startReview();
        }
        // Review modal shortcuts
        const modalOpen = !reviewModal.classList.contains('hidden');
        if (modalOpen) {
          if (e.key === ' ' && reviewShow && !reviewShow.classList.contains('hidden')) {
            e.preventDefault();
            revealAnswer();
          } else if (['1','2','3','4'].includes(e.key) && !reviewGrades.classList.contains('hidden')) {
            e.preventDefault();
            const map = { '1': 1, '2': 3, '3': 4, '4': 5 };
            gradeAndNext(map[e.key]);
          } else if (e.key === 'Escape') {
            e.preventDefault();
            closeReview();
          }
        }
      });

      // Theme toggle button
      themeToggle.addEventListener('click', () => {
        const dark = document.documentElement.classList.contains('dark');
        const next = dark ? 'light' : 'dark';
        localStorage.setItem(THEME_KEY, next);
        applyTheme(next);
      });

      // Import/Export functionality
      let currentImportType = '';


      // Toggle dropdown menus
      exportBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        exportMenu.classList.toggle('hidden');
        importMenu.classList.add('hidden');
      });


      // Review handlers
      reviewBtn.addEventListener('click', startReview);
      reviewClose.addEventListener('click', closeReview);
      reviewShow.addEventListener('click', revealAnswer);
      gradeAgain.addEventListener('click', () => gradeAndNext(1));
      gradeHard.addEventListener('click', () => gradeAndNext(3));
      gradeGood.addEventListener('click', () => gradeAndNext(4));
      gradeEasy.addEventListener('click', () => gradeAndNext(5));
      // Review TTS handlers
      reviewSpeakEn?.addEventListener('click', () => {
        const n = reviewQueue[reviewIndex];
        if (n) speak(n.en, 'en');
      });
      reviewSpeakId?.addEventListener('click', () => {
        const n = reviewQueue[reviewIndex];
        if (n) speak(n.id, 'id');
      });
      reviewStopTts?.addEventListener('click', stopSpeak);

      importBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        importMenu.classList.toggle('hidden');
        exportMenu.classList.add('hidden');
      });

      // Close menus when clicking outside (only if click is outside each menu and its button)
      document.addEventListener('click', (e) => {
        const t = e.target;
        // Export menu
        if (!exportBtn.contains(t) && !exportMenu.contains(t)) {
          exportMenu.classList.add('hidden');
        }
        // Import menu
        if (!importBtn.contains(t) && !importMenu.contains(t)) {
          importMenu.classList.add('hidden');
        }
        // Close any open action strips after any outside click
        document.querySelectorAll('.action-strip').forEach(el => el.classList.remove('show'));
      });

      // Export functions
      function exportAsJSON() {
        const exportData = {
          version: '1.1',
          exportDate: new Date().toISOString(),
          totalNotes: notes.length,
          notes: notes.map(note => ({
            id: note.id,
            english: note.en,
            indonesian: note.id,
            tags: note.tags || [],
            isFavorite: note.isFavorite || false,
            createdAt: note.createdAt,
            createdDate: new Date(note.createdAt).toISOString(),
            // Scheduling fields
            dueAt: note.dueAt ?? null,
            interval: note.interval ?? null,
            repetitions: note.repetitions ?? null,
            ease: note.ease ?? null,
            lastReviewedAt: note.lastReviewedAt ?? null,
            lapses: note.lapses ?? null
          }))
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `notes-backup-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        exportMenu.classList.add('hidden');
      }

      function exportAsCSV() {
        const headers = ['English', 'Indonesian', 'Tags', 'Favorite', 'Created Date'];
        const csvRows = [headers.join(',')];
        
        notes.forEach(note => {
          const row = [
            `"${note.en.replace(/"/g, '""')}"`,
            `"${note.id.replace(/"/g, '""')}"`,
            `"${(note.tags || []).join(', ').replace(/"/g, '""')}"`,
            `"${note.isFavorite ? 'Yes' : 'No'}"`,
            `"${new Date(note.createdAt).toISOString()}"`
          ];
          csvRows.push(row.join(','));
        });
        
        const csvStr = csvRows.join('\n');
        const dataBlob = new Blob([csvStr], { type: 'text/csv' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `notes-backup-${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        exportMenu.classList.add('hidden');
      }

      // Import functions
      function importFromJSON(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const importData = JSON.parse(e.target.result);
            let importNotes = [];
            
            // Handle different JSON structures
            if (importData.notes && Array.isArray(importData.notes)) {
              // New format with metadata
              importNotes = importData.notes;
            } else if (importData.vocabulary && Array.isArray(importData.vocabulary)) {
              // Vocabulary format (like data.json)
              importNotes = importData.vocabulary;
            } else if (Array.isArray(importData)) {
              // Direct array format
              importNotes = importData;
            } else {
              throw new Error('Invalid JSON format. Expected notes, vocabulary array, or direct array.');
            }
            
            let imported = 0;
            let skipped = 0;
            importNotes.forEach(note => {
              let en, id;
              
              if (note.english && note.indonesian) {
                en = note.english.trim();
                id = note.indonesian.trim();
              } else if (note.en && note.id) {
                en = note.en.trim();
                id = note.id.trim();
              } else {
                return; // Skip invalid entries
              }
              
              // Skip duplicates
              if (isDuplicate(en, id)) {
                skipped++;
                return;
              }
              
              const newNote = {
                id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2),
                en: en,
                id: id,
                tags: Array.isArray(note.tags) ? note.tags.filter(tag => tag.trim()).map(tag => tag.trim().toLowerCase()) : [],
                isFavorite: note.isFavorite || false,
                createdAt: note.createdAt || Date.now(),
                ease: note.ease ?? 2.5,
                repetitions: note.repetitions ?? 0,
                interval: note.interval ?? 0,
                lapses: note.lapses ?? 0,
                lastReviewedAt: note.lastReviewedAt ?? 0,
                dueAt: note.dueAt ?? Date.now()
              };
              notes.unshift(newNote);
              imported++;
            });
            
            saveNotes();
            ensureScheduleForAll();
            updateTagFilter();
            renderNotes();
            updateDueBadge();
            
            let message = `Successfully imported ${imported} notes!`;
            if (skipped > 0) {
              message += ` ${skipped} duplicate(s) were skipped.`;
            }
            
            Swal.fire({
              title: 'Import Successful!',
              text: message,
              icon: 'success',
              confirmButtonColor: '#3085d6'
            });
          } catch (error) {
            Swal.fire({
              title: 'Import Error',
              text: 'Error importing JSON file: ' + error.message,
              icon: 'error',
              confirmButtonColor: '#3085d6'
            });
          }
        };
        reader.readAsText(file);
      }

      function importFromCSV(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const csvText = e.target.result;
            const lines = csvText.split('\n').filter(line => line.trim());
            
            if (lines.length < 2) {
              throw new Error('CSV file must have at least a header and one data row');
            }
            
            // Skip header row
            const dataLines = lines.slice(1);
            let imported = 0;
            let skipped = 0;
            
            dataLines.forEach(line => {
              // Simple CSV parser (handles quoted fields)
              const fields = [];
              let current = '';
              let inQuotes = false;
              
              for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                  if (inQuotes && line[i + 1] === '"') {
                    current += '"';
                    i++; // Skip next quote
                  } else {
                    inQuotes = !inQuotes;
                  }
                } else if (char === ',' && !inQuotes) {
                  fields.push(current);
                  current = '';
                } else {
                  current += char;
                }
              }
              fields.push(current); // Add last field
              
              if (fields.length >= 2 && fields[0].trim() && fields[1].trim()) {
                const en = fields[0].trim();
                const id = fields[1].trim();
                
                // Skip duplicates
                if (isDuplicate(en, id)) {
                  skipped++;
                  return;
                }
                
                const tagsField = fields[2] ? fields[2].trim() : '';
                const tags = tagsField ? tagsField.split(',').map(tag => tag.trim().toLowerCase()).filter(tag => tag) : [];
                const isFavorite = fields[3] ? (fields[3].trim().toLowerCase() === 'yes' || fields[3].trim().toLowerCase() === 'true') : false;
                const createdAt = fields[4] ? new Date(fields[4]).getTime() || Date.now() : Date.now();
                
                const newNote = {
                  id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2),
                  en: en,
                  id: id,
                  tags: tags,
                  isFavorite: isFavorite,
                  createdAt: createdAt,
                  // Scheduling defaults
                  ease: 2.5,
                  repetitions: 0,
                  interval: 0,
                  lapses: 0,
                  lastReviewedAt: 0,
                  dueAt: Date.now()
                };
                notes.unshift(newNote);
                imported++;
              }
            });
            
            saveNotes();
            ensureScheduleForAll();
            updateTagFilter();
            renderNotes();
            updateDueBadge();
            
            let message = `Successfully imported ${imported} notes from CSV!`;
            if (skipped > 0) {
              message += ` ${skipped} duplicate(s) were skipped.`;
            }
            
            Swal.fire({
              title: 'Import Successful!',
              text: message,
              icon: 'success',
              confirmButtonColor: '#3085d6'
            });
          } catch (error) {
            Swal.fire({
              title: 'Import Error',
              text: 'Error importing CSV file: ' + error.message,
              icon: 'error',
              confirmButtonColor: '#3085d6'
            });
          }
        };
        reader.readAsText(file);
      }

      // Event handlers for export buttons
      exportJsonBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (notes.length === 0) {
          Swal.fire({
            title: 'No Notes to Export',
            text: 'Please add some notes first before exporting.',
            icon: 'info',
            confirmButtonColor: '#3085d6'
          });
          return;
        }
        exportAsJSON();
      });

      exportCsvBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (notes.length === 0) {
          Swal.fire({
            title: 'No Notes to Export',
            text: 'Please add some notes first before exporting.',
            icon: 'info',
            confirmButtonColor: '#3085d6'
          });
          return;
        }
        exportAsCSV();
      });

      // Event handlers for import buttons
      importJsonBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        currentImportType = 'json';
        fileInput.accept = '.json';
        fileInput.click();
        importMenu.classList.add('hidden');
      });

      importCsvBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        currentImportType = 'csv';
        fileInput.accept = '.csv';
        fileInput.click();
        importMenu.classList.add('hidden');
      });

      // File input change handler
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (currentImportType === 'json') {
          if (!file.name.toLowerCase().endsWith('.json')) {
            alert('Please select a JSON file');
            return;
          }
          importFromJSON(file);
        } else if (currentImportType === 'csv') {
          if (!file.name.toLowerCase().endsWith('.csv')) {
            alert('Please select a CSV file');
            return;
          }
          importFromCSV(file);
        }
        
        // Reset file input
        fileInput.value = '';
      });

      // Init
      initTheme();
      loadNotes();
      ensureScheduleForAll();
      updateTagFilter();
      renderNotes();
      updateDueBadge();
      // Hide TTS UI if unsupported
      if (!ttsSupported) {
        document.querySelectorAll('.tts-only').forEach(el => el.classList.add('hidden'));
      }
    </script>
</body>
</html>
